{% extends 'base.html' %}
{% block title %}Analisa Tandan{% endblock %}

{% block content %}
<h2 class="mt-3 mb-3">Analisa Tandan</h2>
<style>
  /* --- Toolbar Styling --- */
  .top-toolbar {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: #fff;
    padding: 10px 15px;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap; /* keep responsive but try to stay in one row */
    gap: 15px;
  }

  .top-toolbar form {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .top-toolbar label {
    white-space: nowrap;
    font-weight: 600;
  }

  .top-toolbar select,
  .top-toolbar input[type="file"] {
    width: auto;
    min-width: 160px;
  }

  .top-toolbar .input-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .top-toolbar .btn {
    white-space: nowrap;
  }

  /* Optional: keep everything in one line for large screens */
  @media (max-width: 992px) {
    .top-toolbar {
      flex-direction: column;
      align-items: flex-start;
    }
    .top-toolbar form {
      flex-wrap: wrap;
    }
  }
</style>

<!-- üîù Toolbar: Upload + Filters + Export -->
<div class="top-toolbar shadow-sm">

    <!-- üì§ Upload CSV -->
    <form action="{{ url_for('dashboard.upload_csv_analisa_tandan') }}"
        method="POST" enctype="multipart/form-data">
        <div class="input-group">
            <label for="file" class="form-label mb-0"><strong>Upload
                    CSV:</strong></label>
            <input type="file" name="file" id="file" accept=".csv"
                class="form-control" required>
            <button type="submit" class="btn btn-primary">Upload</button>
        </div>
    </form>

    <!-- üîç Filters + Export -->
    <form method="get" action="{{ url_for('analisa_tandan') }}">
        <label for="no_percobaan" class="form-label mb-0">No Percobaan:</label>
        <select name="no_percobaan" id="no_percobaan" class="form-select"
            onchange="this.form.submit()">
            <option value>Semua</option>
            {% for item in no_percobaan_list %}
            <option value="{{ item }}" {% if item == selected_no_percobaan
                %}selected{% endif %}>{{ item }}</option>
            {% endfor %}
        </select>

        <label for="tahun_record" class="form-label mb-0">Tahun:</label>
        <select name="tahun_record" id="tahun_record" class="form-select"
            onchange="this.form.submit()">
            <option value>Semua</option>
            {% for t in tahun_list %}
            <option value="{{ t }}" {% if t|string == selected_tahun
                %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>

        <label for="bulan_record" class="form-label mb-0">Bulan:</label>
        <select name="bulan_record" id="bulan_record" class="form-select"
            onchange="this.form.submit()">
            <option value>Semua</option>
            {% for b in bulan_list %}
            <option value="{{ b }}" {% if b|string == selected_bulan
                %}selected{% endif %}>
                {{
                ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'][b-1]
                }}
            </option>
            {% endfor %}
        </select>

        <a
            href="{{ url_for('export_analisa_tandan_xls', no_percobaan=selected_no_percobaan, tahun_record=selected_tahun, bulan_record=selected_bulan) }}"
            class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
        </a>
    </form>

</div>

<div class="table-responsive" style="max-height: 75vh; overflow-y: auto;">
    <table class="table table-bordered table-sm align-middle text-center"
        style="font-size: 12px;">
        <thead class="table-light">
            <!-- Baris 1: Kategori -->
            <tr style="font-weight: normal; background-color: #f5f5f5;">
                <th colspan="8">üåæ 1. Identitas Sampel dan Percobaan</th>
                <th colspan="6">üå¥ 2. Data Tandan</th>
                <th colspan="20">ü•• 3. Data Komponen Buah</th>
                <th colspan="12">‚öóÔ∏è 4. Analisis Laboratorium</th>
                <th colspan="10">üìä 5. Hasil Perhitungan & Rasio Komponen</th>
            </tr>

            <!-- Baris 2: Nama kolom -->
            <tr style="font-weight: normal;">
                <!-- 1Ô∏è‚É£ Identitas -->
                <th>id</th>
                <th>tanggal panen</th>
                <th>no percobaan</th>
                <th>no kartu</th>
                <th>no analisa</th>
                <th>no baris</th>
                <th>no pokok</th>
                <th>no sampel</th>
                <th>No persilangan</th>

                <!-- 2Ô∏è‚É£ Data Tandan -->
                <th>berat tandan</th>
                <th>stalk</th>
                <th>type buah</th>
                <th>Spikelet</th>
                <th>Berat Contoh Buah</th>
                <th>Jumlah Buah</th>

                <!-- 3Ô∏è‚É£ Komponen Buah -->
                <th>berat buah A</th>
                <th>berat buah B</th>
                <th>Berat Mes A</th>
                <th>Berat Mes B</th>
                <th>Berat Biji</th>
                <th>Berat Inti</th>
                <th>Berat Cangkang</th>
                <th>Mesokarp</th>
                <th>Berat Mesokarp Segar</th>
                <th>Berat Mesokarp Kering</th>
                <th>Berat Mangkok</th>
                <th>Mangkok Mesocarp</th>
                <th>Mangkok Mesocarp Kering</th>
                <th>Berat Kantong Kosong A</th>
                <th>Berat Kantong Kosong B</th>
                <th>Berat Kantong Mess A</th>
                <th>Berat Kantong Mess B</th>
                <th>Berat Kantong Meso Sox_A</th>
                <th>Berat Kantong Meso Sox_B</th>
                <th>Contoh A</th>
                <th>Contoh B</th>

                <!-- 4Ô∏è‚É£ Analisis Lab -->
                <th>Berat Serat A</th>
                <th>Berat Serat B</th>
                <th>Berat Minyak A</th>
                <th>Berat Minyak B</th>
                <th>% Serat Meso A</th>
                <th>% Serat Meso B</th>
                <th>% Minyak per Mes Kering A</th>
                <th>% Minyak per Mes Kering B</th>
                <th>% Minyak per Mes Segar A</th>
                <th>% Minyak per Mes Segar B</th>
                <th>Kadar Air</th>

                <!-- 5Ô∏è‚É£ Hasil & Rasio -->
                <th>% Tandan</th>
                <th>% Mesocarp</th>
                <th>% Cangkang</th>
                <th>% Inti Buah</th>
                <th>% Minyak Mes Kering</th>
                <th>% Minyak Mes Segar</th>
                <th>% Minyak Tandan</th>
                <th>% Rendemen</th>
                <th>% Inti Tandan</th>
                <th>Selisih</th>
                <th>palm ID</th>
                <th>Created At</th>
                <th>Updated At</th>
            </tr>
        </thead>

        <tbody>
            {% if data %}
            {% for row in data %}
            <tr>
                {% for col in headers %}
                <td>{{ row[col] }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="{{ headers|length }}"
                    class="text-center text-muted">
                    (Tidak ada data ditampilkan)
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
