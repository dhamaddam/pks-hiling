{% extends 'base.html' %}
{% block title %}Data Panen Tandan{% endblock %}

{% block content %}

<style>
  table.table {
    border-color: #dcdcdc;
  }
  thead th {
    background-color: #f8f9fa !important;
    vertical-align: middle !important;
  }
  tbody td {
    vertical-align: middle !important;
  }
  .table-responsive {
    max-height: 70vh;
    overflow-y: auto;
  }
  .top-toolbar {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #fff;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 10px;
    border-bottom: 1px solid #ddd;
  }
</style>

<div class="top-toolbar shadow-sm">

  <!-- ðŸ“¤ Upload CSV -->
  <form action="{{ url_for('dashboard.upload_csv_produksi') }}" method="POST"
        enctype="multipart/form-data"
        class="d-flex align-items-center gap-2 mb-0">
    <label for="file" class="form-label mb-0"><strong>Upload CSV Produksi:</strong></label>
    <input type="file" name="file" id="file" accept=".csv"
           class="form-control form-control-sm" required>
    <button type="submit" class="btn btn-primary btn-sm">Upload</button>
  </form>

  <!-- ðŸ” Filters + Export -->
  <form method="get" action="{{ url_for('produksi') }}" class="d-flex align-items-center gap-2 mb-0">

    <label for="tahun_record" class="form-label mb-0">Tahun:</label>
    <select name="tahun_record" id="tahun_record"
            class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="">Semua</option>
      {% for t in tahun_list %}
        <option value="{{ t }}" {% if t|string == selected_tahun %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>

    <label for="bulan_record" class="form-label mb-0">Bulan:</label>
    <select name="bulan_record" id="bulan_record"
            class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="">Semua</option>
      {% for b in bulan_list %}
        <option value="{{ b }}" {% if b|string == selected_bulan %}selected{% endif %}>
          {{ ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'][b|int - 1] }}
        </option>
      {% endfor %}
    </select>

    <!-- Export Button -->
    <a href="{{ url_for('export_produksi_xls', tahun_record=selected_tahun, bulan_record=selected_bulan) }}"
       class="btn btn-success btn-sm">
      <i class="bi bi-file-earmark-excel"></i> Export Excel
    </a>
  </form>
</div>

<h2 class="mt-3 mb-3">Data Panen Tandan (Bunch Harvest)</h2>

<div class="table-responsive">
  <table class="table table-bordered table-sm align-middle text-center" style="font-size: 12px;">
    <thead class="table-light">
      <!-- ðŸ§¾ Baris 1: Kategori Utama -->
      <tr style="font-weight: normal; background-color: #f9f9f9;">
        <th colspan="5">ðŸ§¾ 1. Informasi Waktu & Identitas Percobaan</th>
        <th colspan="2">ðŸŒ± 2. Posisi Tanaman di Lapangan</th>
        <th colspan="11">ðŸŒ¾ 3. Data Panen Tandan (Periode Panen)</th>
        <th colspan="3">ðŸ“Š 4. Total Produksi & Hasil Rata-Rata</th>
      </tr>

      <tr class="table-light text-dark fw-semibold">
        {% for h in headers %}
          <th>{{ h }}</th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% if data %}
        {% for row in data %}
          <tr>
            {% for col in headers %}
              <td>{{ row[col] }}</td>
            {% endfor %}
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="{{ headers|length }}" class="text-center text-muted">
            (Tidak ada data ditampilkan)
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center mt-3">
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('produksi', page=page-1,
                            tahun_record=selected_tahun,
                            bulan_record=selected_bulan) }}">
          Previous
        </a>
      </li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">Halaman {{ page }} / {{ total_pages }}</span>
    </li>

    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('produksi', page=page+1,
                            tahun_record=selected_tahun,
                            bulan_record=selected_bulan) }}">
          Next
        </a>
      </li>
    {% endif %}
  </ul>
</nav>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% endblock %}
